---
import '../styles/global.css';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WASM Notes - Extensible Notes App</title>
  <meta name="description" content="A notes app powered by WebAssembly plugins">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>üìù WASM Notes</h1>
        <p>Extensible notes with WASM plugins</p>
      </div>
      <div class="notes-list" id="notesList">
        <!-- Notes will be inserted here -->
      </div>
      <button class="new-note-btn" id="newNoteBtn">+ New Note</button>
    </aside>

    <!-- Main Editor -->
    <main class="main-content">
      <div id="emptyState" class="empty-state">
        <h2>Welcome to WASM Notes</h2>
        <p>Create a new note to get started</p>
      </div>

      <div id="editorContainer" style="display: none; flex: 1; display: flex; flex-direction: column;">
        <div class="editor-header">
          <input type="text" id="noteTitle" placeholder="Untitled Note" />
          <div class="editor-actions">
            <button class="btn danger" id="deleteBtn">Delete</button>
          </div>
        </div>

        <div class="editor-content">
          <!-- Editor Pane -->
          <div class="editor-pane">
            <h2>‚úçÔ∏è Editor</h2>
            <textarea id="noteContent" placeholder="Start writing..."></textarea>
          </div>

          <!-- Preview Pane -->
          <div class="editor-pane">
            <h2>
              üëÅÔ∏è Live Preview
              <span class="plugin-badge">Markdown</span>
              <span class="plugin-badge">Word Counter</span>
              <span class="plugin-badge">Tags</span>
            </h2>

            <!-- Stats -->
            <div class="stats-grid" id="statsContainer">
              <!-- Will be populated by word-counter plugin -->
            </div>

            <!-- Tags -->
            <div id="tagsContainer" style="margin-bottom: 1rem;">
              <!-- Will be populated by tag-manager plugin -->
            </div>

            <!-- Markdown Preview -->
            <div class="preview-content" id="markdownPreview">
              <!-- Will be populated by markdown plugin -->
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    import { PluginLoader } from '../lib/plugin-loader.js';

    // Notes Storage
    class NotesApp {
      constructor() {
        this.notes = this.loadNotes();
        this.currentNoteId = null;
        this.plugins = null;
        this.pluginLoader = new PluginLoader();
      }

      loadNotes() {
        const stored = localStorage.getItem('wasm-notes');
        return stored ? JSON.parse(stored) : [];
      }

      saveNotes() {
        localStorage.setItem('wasm-notes', JSON.stringify(this.notes));
      }

      createNote() {
        const note = {
          id: Date.now(),
          title: 'Untitled Note',
          content: '',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        this.notes.unshift(note);
        this.saveNotes();
        return note;
      }

      updateNote(id, updates) {
        const note = this.notes.find(n => n.id === id);
        if (note) {
          Object.assign(note, updates, { updatedAt: new Date().toISOString() });
          this.saveNotes();
        }
      }

      deleteNote(id) {
        this.notes = this.notes.filter(n => n.id !== id);
        this.saveNotes();
      }

      getNote(id) {
        return this.notes.find(n => n.id === id);
      }
    }

    // Initialize App
    const app = new NotesApp();
    let updateTimeout = null;

    // DOM Elements
    const notesList = document.getElementById('notesList');
    const emptyState = document.getElementById('emptyState');
    const editorContainer = document.getElementById('editorContainer');
    const noteTitle = document.getElementById('noteTitle');
    const noteContent = document.getElementById('noteContent');
    const newNoteBtn = document.getElementById('newNoteBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const markdownPreview = document.getElementById('markdownPreview');
    const statsContainer = document.getElementById('statsContainer');
    const tagsContainer = document.getElementById('tagsContainer');

    // Load plugins
    async function initPlugins() {
      try {
        await app.pluginLoader.loadAllPlugins();
        app.plugins = {
          markdown: app.pluginLoader.getPlugin('markdown-plugin'),
          wordCounter: app.pluginLoader.getPlugin('word-counter-plugin'),
          tagManager: app.pluginLoader.getPlugin('tag-manager-plugin')
        };
        console.log('All plugins initialized!');
      } catch (error) {
        console.error('Failed to initialize plugins:', error);
      }
    }

    // Render notes list
    function renderNotesList() {
      if (app.notes.length === 0) {
        notesList.innerHTML = '<p style="padding: 1rem; color: var(--text-muted); text-align: center;">No notes yet</p>';
        return;
      }

      notesList.innerHTML = app.notes.map(note => `
        <div class="note-item ${note.id === app.currentNoteId ? 'active' : ''}" data-id="${note.id}">
          <h3>${escapeHtml(note.title)}</h3>
          <p>${escapeHtml(note.content.substring(0, 60))}${note.content.length > 60 ? '...' : ''}</p>
        </div>
      `).join('');

      // Add click handlers
      document.querySelectorAll('.note-item').forEach(item => {
        item.addEventListener('click', () => {
          loadNote(parseInt(item.dataset.id));
        });
      });
    }

    // Load a note
    function loadNote(id) {
      const note = app.getNote(id);
      if (!note) return;

      app.currentNoteId = id;
      noteTitle.value = note.title;
      noteContent.value = note.content;

      emptyState.style.display = 'none';
      editorContainer.style.display = 'flex';

      renderNotesList();
      updatePreview();
    }

    // Update preview with plugins
    function updatePreview() {
      const content = noteContent.value;

      // Markdown Plugin
      if (app.plugins?.markdown) {
        try {
          const html = app.plugins.markdown.render(content);
          markdownPreview.innerHTML = html || '<p style="color: var(--text-muted);">Preview will appear here...</p>';
        } catch (error) {
          console.error('Markdown plugin error:', error);
        }
      }

      // Word Counter Plugin
      if (app.plugins?.wordCounter) {
        try {
          const stats = app.plugins.wordCounter.count(content);
          statsContainer.innerHTML = `
            <div class="stat-card">
              <div class="stat-value">${stats.words}</div>
              <div class="stat-label">Words</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${stats.characters}</div>
              <div class="stat-label">Characters</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${stats.lines}</div>
              <div class="stat-label">Lines</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${stats.paragraphs}</div>
              <div class="stat-label">Paragraphs</div>
            </div>
          `;
        } catch (error) {
          console.error('Word counter plugin error:', error);
        }
      }

      // Tag Manager Plugin
      if (app.plugins?.tagManager) {
        try {
          const tags = app.plugins.tagManager.extract_tags(content);
          if (tags.length > 0) {
            tagsContainer.innerHTML = `
              <h3 style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">TAGS</h3>
              <div class="tags-container">
                ${tags.map(tag => `<span class="tag">#${escapeHtml(tag)}</span>`).join('')}
              </div>
            `;
          } else {
            tagsContainer.innerHTML = '';
          }
        } catch (error) {
          console.error('Tag manager plugin error:', error);
        }
      }
    }

    // Event Handlers
    newNoteBtn.addEventListener('click', () => {
      const note = app.createNote();
      loadNote(note.id);
    });

    deleteBtn.addEventListener('click', () => {
      if (!app.currentNoteId) return;
      if (!confirm('Delete this note?')) return;

      app.deleteNote(app.currentNoteId);
      app.currentNoteId = null;

      emptyState.style.display = 'flex';
      editorContainer.style.display = 'none';

      renderNotesList();
    });

    noteTitle.addEventListener('input', () => {
      if (!app.currentNoteId) return;
      app.updateNote(app.currentNoteId, { title: noteTitle.value });
      clearTimeout(updateTimeout);
      updateTimeout = setTimeout(renderNotesList, 500);
    });

    noteContent.addEventListener('input', () => {
      if (!app.currentNoteId) return;
      app.updateNote(app.currentNoteId, { content: noteContent.value });
      updatePreview();
    });

    // Helper function
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize
    async function init() {
      await initPlugins();
      renderNotesList();

      // Load first note if exists
      if (app.notes.length > 0) {
        loadNote(app.notes[0].id);
      }
    }

    init();
  </script>
</body>
</html>
